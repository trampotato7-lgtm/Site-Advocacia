<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gerenciar Site - Edson Maltez</title>
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  
  <!-- Carregar marked para processar markdown -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
  <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
  
  <script>
    // Função para extrair ID do YouTube
    function extractYouTubeId(url) {
      if (!url) return null;
      const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
      const match = url.match(regExp);
      return (match && match[2].length === 11) ? match[2] : null;
    }

    // Componente de pré-visualização (usando a versão do React do Decap CMS)
    const PostPreview = ({ entry }) => {
      // Pegar dados do entry
      const title = entry.getIn(['data', 'title']) || 'Sem título';
      const date = entry.getIn(['data', 'date']) || new Date().toISOString();
      const category = entry.getIn(['data', 'category']);
      const description = entry.getIn(['data', 'description']);
      const image = entry.getIn(['data', 'image']);
      const featuredVideo = entry.getIn(['data', 'featured_video']);
      const author = entry.getIn(['data', 'author']) || 'Edson Silva Maltez';
      const body = entry.getIn(['data', 'body']) || '';

      // Criar elementos com React.createElement (já disponível globalmente)
      const h = React.createElement;

      // Processar vídeo
      let videoElement = null;
      if (featuredVideo) {
        const videoData = featuredVideo.toJSON ? featuredVideo.toJSON() : featuredVideo;
        
        if (videoData.type === 'youtube' && videoData.url) {
          const videoId = extractYouTubeId(videoData.url);
          if (videoId) {
            const iframe = h('iframe', {
              src: `https://www.youtube.com/embed/${videoId}`,
              allowFullScreen: true,
              style: { width: '100%', height: '315px', border: 'none', borderRadius: '8px' }
            });
            
            videoElement = h('div', { className: 'video-preview' },
              iframe,
              videoData.caption ? h('div', { className: 'video-caption' }, videoData.caption) : null
            );
          }
        } else if (videoData.type === 'upload' && videoData.file) {
          const video = h('video', { controls: true, style: { width: '100%', maxHeight: '400px', borderRadius: '8px' } },
            h('source', { src: videoData.file, type: 'video/mp4' })
          );
          
          videoElement = h('div', { className: 'video-preview' },
            video,
            videoData.caption ? h('div', { className: 'video-caption' }, videoData.caption) : null
          );
        }
      }

      // Processar imagem
      const imageElement = !featuredVideo && image ? 
        h('img', { src: image, className: 'preview-image', style: { width: '100%', maxHeight: '400px', objectFit: 'cover', borderRadius: '8px', marginBottom: '30px' } }) : null;

      // Processar markdown
      const contentHtml = window.marked ? window.marked.parse(body) : body;

      // Formatar data
      const formattedDate = new Date(date).toLocaleDateString('pt-BR');

      // Montar componente
      return h('div', { className: 'preview-container', style: { fontFamily: 'Arial, sans-serif', maxWidth: '800px', margin: '0 auto', padding: '20px', background: 'white', boxShadow: '0 2px 10px rgba(0,0,0,0.1)' } },
        
        // Header
        h('div', { className: 'preview-header', style: { background: 'linear-gradient(135deg, #0a2472 0%, #1e3a8a 100%)', color: 'white', padding: '40px', textAlign: 'center', marginBottom: '30px', borderRadius: '8px' } },
          category ? h('span', { style: { background: '#c9a227', color: '#0a2472', padding: '4px 12px', borderRadius: '20px', fontSize: '12px', fontWeight: 'bold', display: 'inline-block', marginBottom: '15px' } }, category) : null,
          h('h1', { style: { fontSize: '36px', margin: '10px 0' } }, title),
          description ? h('p', { style: { fontSize: '18px', opacity: 0.9, maxWidth: '600px', margin: '15px auto' } }, description) : null,
          h('div', { style: { display: 'flex', justifyContent: 'center', gap: '20px', marginTop: '20px', fontSize: '14px', opacity: 0.8 } },
            h('span', null, `📅 ${formattedDate}`),
            h('span', null, `⚖️ ${author}`)
          )
        ),
        
        // Vídeo ou imagem
        videoElement,
        imageElement,
        
        // Conteúdo
        h('div', { 
          className: 'preview-content',
          style: { fontSize: '16px', lineHeight: '1.8', color: '#333' },
          dangerouslySetInnerHTML: { __html: contentHtml }
        }),
        
        // Footer
        h('div', { style: { marginTop: '50px', paddingTop: '20px', borderTop: '2px solid #c9a227', textAlign: 'center', fontSize: '14px', color: '#666' } },
          `Publicado por ${author} • OAB/SP 344.956`
        )
      );
    };

    // Registrar o componente
    CMS.registerPreviewTemplate('posts', PostPreview);

    // Registrar estilos adicionais (opcional)
    CMS.registerPreviewStyle(`
      .preview-content h1 { font-size: 32px; margin: 20px 0 10px; color: #0a2472; }
      .preview-content h2 { font-size: 28px; margin: 18px 0 8px; color: #1e3a8a; }
      .preview-content h3 { font-size: 24px; margin: 16px 0 6px; }
      .preview-content p { margin: 15px 0; }
      .preview-content blockquote {
        border-left: 4px solid #c9a227;
        padding-left: 20px;
        margin: 20px 0;
        font-style: italic;
        color: #555;
        background: #f9f9f9;
        padding: 15px 20px;
        border-radius: 0 8px 8px 0;
      }
      .preview-content ul, .preview-content ol { margin: 15px 0; padding-left: 30px; }
      .preview-content li { margin: 5px 0; }
      .preview-content a { color: #c9a227; text-decoration: none; }
      .preview-content a:hover { text-decoration: underline; }
      .preview-content img {
        max-width: 100%;
        height: auto;
        border-radius: 8px;
        margin: 20px 0;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      }
    `);

    console.log('Pré-visualização carregada com React do Decap CMS!');
  </script>
</body>
</html>